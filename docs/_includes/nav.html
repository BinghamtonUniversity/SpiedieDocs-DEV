{%- comment -%}
    This will generate a list (<ul> and <li>) with all the pages not marked to
    be excluded from the navigation.
    The entries will be ordered by the "nav_order" front matter, and if the
    pages are within a folder it will create a section for those entries (only
    1 level deep).

    Jekyll doesn't offer a way to see if there are next or previous pages, as
    it is only available for posts. As we have a specific other anyway, this
    will also create the "previous_page" and "next_page" global variables with
    URLs to add as links/buttons in other parts of the layout.

    WARNING! The  looping around the list of pages here is not a good method
    to implement this, but the Liquid template language is very limited.
{%- endcomment -%}

{%- assign nav_pages = site.pages | where_exp: "p", "p.extname == '.md' and p.hide != true and p.nav_exclude != true" | sort: "nav_order" -%}

{%- assign root_pages = nav_pages | where_exp: "p", "p.dir == ''" -%}
<ul class="nav-root">
  {%- for page in root_pages %}
    <li>
      <a href="{{ page.url | absolute_url }}">{{ page.title }}</a>
    </li>
  {%- endfor %}
</ul>

{%- assign grouped = {} -%}
{%- for page in nav_pages %}
  {%- assign dir_parts = page.dir | split: "/" -%}
  {%- assign section = dir_parts[0] | default: "" -%}
  {%- assign subsection = dir_parts[1] | default: "" -%}
  {%- assign key = section | append: "/" | append: subsection -%}

  {%- if grouped[key] == nil -%}
    {%- assign grouped = grouped | merge: { (key): [page] } -%}
  {%- else -%}
    {%- assign grouped[key] = grouped[key] | push: page -%}
  {%- endif -%}
{%- endfor %}

{%- assign keys = grouped | keys | sort -%}
{%- assign last_section = "" -%}

{%- for key in keys %}
  {%- assign section = key | split: "/" | first -%}
  {%- assign subsection = key | split: "/" | last -%}
  {%- assign pages = grouped[key] -%}

  {%- if section != last_section %}
    {%- if last_section != "" %}</ul></div>{% endif %}
    <div class="collapsible-container" id="section-{{ section | slugify }}">
      <button class="collapsible">{{ section }}</button>
      <ul class="collapsible-content">
  {%- endif %}

  {%- if subsection != section %}
    <li>
      <strong>{{ subsection }}</strong>
      <ul>
        {%- for page in pages %}
          <li><a href="{{ page.url | absolute_url }}">{{ page.title }}</a></li>
        {%- endfor %}
      </ul>
    </li>
  {%- else %}
    {%- for page in pages %}
      <li><a href="{{ page.url | absolute_url }}">{{ page.title }}</a></li>
    {%- endfor %}
  {%- endif %}

  {%- assign last_section = section -%}
{%- endfor %}
</ul></div>