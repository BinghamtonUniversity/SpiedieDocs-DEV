{%- assign sorted_pages = site.pages 
    | where_exp: "p", "p.path contains 'docs/'"
    | sort: "nav_order"
    | reject: "path", "contains:assets"
-%}

{%- assign folder_objects = "" | split: "" -%}

{%- for page in sorted_pages %}
  {%- if page.nav_exclude != true -%}

    {%- assign dir_name = page.dir | split: "/" | last -%}

    {%- assign num_prefix = dir_name | regex_replace: "^([0-9]+).*", "\1" -%}
    {%- assign has_number = dir_name | regex_match: "^[0-9]+" -%}

    {%- if has_number %}
      {%- assign clean_name = dir_name | regex_replace: "^[0-9]+[.\-_ ]*", "" -%}
    {%- else %}
      {%- assign clean_name = dir_name -%}
      {%- assign num_prefix = 9999 -%}   <!-- unsorted guys go last -->
    {%- endif %}

    {%- assign folder_objects = folder_objects 
        | push: 
          ( 
            dir_name | append: "|" 
                     | append: clean_name | append: "|" 
                     | append: num_prefix 
          ) 
    -%}

  {%- endif -%}
{%- endfor %}

{%- assign folder_objects = folder_objects | uniq | sort_natural: "split:'|' | last" -%}

<ol class="toc-l1">
  {%- for folder in folder_objects %}
    {%- assign parts = folder | split: "|" -%}
    {%- assign raw_name   = parts[0] -%}
    {%- assign clean_name = parts[1] -%}

    <li class="toc-item toc-l1-item">
      <h3 class="toc-l1-title">{{ clean_name | replace: "%20", " " }}</h3>

      <ol class="sub-toc toc-l2">
        {%- for page in sorted_pages %}
          {%- assign parent_title = page.dir | split: "/" | last -%}
          {%- if parent_title == raw_name and page.nav_exclude != true -%}
            <li class="toc-item toc-l2-item">
              <a class="toc-link toc-l2-link {% if page.url == site.page.url %}active{% endif %}"
                 href="{{ page.url | relative_url }}">
                {{ page.title }}
              </a>
            </li>
          {%- endif -%}
        {%- endfor %}
      </ol>

    </li>
  {%- endfor %}
</ol>

